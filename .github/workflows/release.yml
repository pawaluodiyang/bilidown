name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Build Frontend
        run: |
          cd client
          pnpm install
          pnpm build
          # Verify static files are generated
          ls -R ../server/static

      - name: Download FFmpeg for Windows
        run: |
          mkdir -p server/bin
          sudo apt-get update && sudo apt-get install -y unzip
          # Download a maintained Windows ffmpeg build
          wget -q https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-win64-gpl.zip
          unzip -q ffmpeg-master-latest-win64-gpl.zip
          mv ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe server/bin/
          rm -rf ffmpeg-master-latest-win64-gpl*
          chmod +x server/bin/ffmpeg.exe
      - name: Pull cross-compile image
        run: docker pull iuroc/cgo-cross-build:latest
      - name: Run GoReleaser in Docker
        run: |
          docker run --rm \
            -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
            -v $PWD:/usr/src/data \
            -w /usr/src/data/server \
            iuroc/cgo-cross-build goreleaser release --clean
